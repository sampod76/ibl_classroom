name: ibl_classroom

on:
  push:
    branches: [main]

concurrency:
  group: ibl_classroom:${{ github.ref }}
  cancel-in-progress: true

jobs:
  deploy:
    name: Build â†’ Upload â†’ Load â†’ Restart
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: ðŸ§  Checkout repository
        uses: actions/checkout@v4

      - name: ðŸ³ Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ðŸ”¨ Build Docker Image (NO CACHE)
        run: |
          docker build --no-cache -t ibl_classroom:latest .

      - name: ðŸ“¦ Save Image to TAR
        run: |
          docker save ibl_classroom:latest | gzip > ibl_classroom.tar.gz

      - name: ðŸ“¤ Upload TAR to VPS
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          source: "ibl_classroom.tar.gz"
          target: "/home/sampod/apps/ibl_classroom/"

      - name: ðŸš€ Run Deploy Script on VPS
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            bash /home/sampod/apps/ibl_classroom/deploy_client.sh

# name: ibl_classroom

# on:
#   push:
#     branches: [main]

# # âœ… One deploy at a time per branch; newer runs cancel older ones
# concurrency:
#   group: ibl_classroom:${{ github.ref }}
#   cancel-in-progress: true

# permissions:
#   contents: read

# jobs:
#   deploy:
#     name: Deploy to VPS dockers
#     runs-on: ubuntu-latest
#     timeout-minutes: 40

#     steps:
#       - name: ðŸ§  Checkout repository
#         uses: actions/checkout@v4
#         with:
#           fetch-depth: 1

#       - name: ðŸš€ Deploy to VPS (SSH Key-based)
#         uses: appleboy/ssh-action@v1.0.3
#         with:
#           host: ${{ secrets.SSH_HOST }}
#           username: ${{ secrets.SSH_USER }}
#           key: ${{ secrets.SSH_PRIVATE_KEY }}
#           port: 22
#           script_stop: true
#           # If your deploy sometimes takes longer, adjust this:
#           command_timeout: 30m
#           script: |
#             bash /home/sampod/apps/ibl_classroom/deploy_client.sh
