name: ibl_classroom

on:
  push:
    branches: [main]

# âœ… One deploy at a time per branch; newer runs cancel older ones
concurrency:
  group: ibl_classroom:${{ github.ref }}
  cancel-in-progress: true

permissions:
  contents: read

jobs:
  deploy:
    name: Deploy to VPS dockers
    runs-on: ubuntu-latest
    timeout-minutes: 40

    steps:
      - name: ğŸ§  Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: ğŸš€ Deploy to VPS (SSH Key-based)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.SSH_HOST }}
          username: ${{ secrets.SSH_USER }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          port: 22
          script_stop: true
          # If your deploy sometimes takes longer, adjust this:
          command_timeout: 30m
          script: |
            set -Eeuo pipefail

            echo "âœ… Connected to server successfully."
            APP_DIR="/home/sampod/apps/ibl_classroom"
            LOCK_FILE="/tmp/ibl_classroom.lock"

            echo "ğŸ“ Changing to dashboard directory..."
            cd "$APP_DIR"

            echo "ğŸ”§ Making deploy script executable..."
            chmod +x deploy_client.sh

            # ğŸ”’ Server-side lock to prevent overlapping deploys (defense-in-depth)
            if command -v flock >/dev/null 2>&1; then
              echo "ğŸ”’ Using flock lock: $LOCK_FILE"
              flock -n "$LOCK_FILE" bash -c '
                set -Eeuo pipefail
                ./deploy_client.sh
              '
            else
              echo "âš ï¸ util-linux (flock) not found; running without lock."
              ./deploy_client.sh
            fi

            echo "ğŸ‰ Deployment completed successfully!"
